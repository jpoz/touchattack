var mode = 'defend';
// var mode = 'attack';

var gameSpeed = 1000; //time player has to hit box
var boxSize = 80;
var benchSize = 15;
var refreshRate = 1000;
var refreshAmount = 50;
var shotCost = 20;
var blockValue = 10;
var gameLength = 30000;

var levels = [

  [[4100, 333, 121], [5100, 192, 93], [6100, 263, 139], [7100, 178, 193], [8100, 288, 44], [9100, 53, 194], [10100, 211, 131], [11100, 222, 161], [12100, 53, 60], [13100, 243, 198], [14100, 270, 167], [15100, 151, 164], [16100, 92, 121], [17100, 274, 117], [18100, 255, 171], [19100, 230, 136], [20100, 153, 173], [21100, 292, 133], [22100, 78, 91], [23100, 258, 49], [24100, 249, 118], [25100, 87, 197], [26100, 339, 170], [27100, 58, 130], [28100, 210, 130], [29100, 196, 161], [30100, 237, 113], [31100, 283, 125], [32100, 53, 158]],
  
  [[4100, 180, 184], [5000, 353, 111], [5900, 272, 129], [6800, 119, 54], [7700, 146, 91], [8600, 228, 110], [9500, 300, 108], [10400, 117, 185], [11300, 288, 69], [12200, 100, 74], [13100, 178, 131], [14000, 119, 112], [14900, 187, 123], [15800, 263, 144], [16700, 336, 148], [17600, 242, 95], [18500, 311, 144], [19400, 185, 64], [20300, 79, 181], [21200, 138, 48], [22100, 279, 90], [23000, 347, 115], [23900, 151, 154], [24800, 298, 132], [25700, 81, 158], [26600, 176, 152], [27500, 115, 43], [28400, 263, 106], [29300, 358, 60], [30200, 269, 175], [31100, 179, 103], [32000, 91, 49]],
  
  [[4100, 186, 172], [4900, 348, 160], [5700, 100, 192], [6500, 106, 49], [7300, 305, 184], [8100, 45, 175], [8900, 342, 128], [9700, 125, 192], [10500, 223, 115], [11300, 77, 169], [12100, 258, 99], [12900, 359, 186], [13700, 302, 139], [14500, 297, 82], [15300, 233, 150], [16100, 237, 143], [16900, 274, 116], [17700, 140, 160], [18500, 182, 106], [19300, 247, 158], [20100, 188, 71], [20900, 49, 48], [21700, 108, 60], [22500, 331, 114], [23300, 267, 103], [24100, 210, 194], [24900, 90, 54], [25700, 339, 51], [26500, 187, 178], [27300, 320, 76], [28100, 87, 112], [28900, 77, 133], [29700, 140, 81], [30500, 309, 73], [31300, 196, 148], [32100, 73, 107]]
  
  [[4100, 109, 168], [4800, 154, 118], [5500, 234, 172], [6200, 269, 84], [6900, 334, 132], [7600, 40, 47], [8300, 145, 57], [9000, 157, 61], [9700, 43, 69], [10400, 229, 134], [11100, 243, 184], [11800, 169, 94], [12500, 127, 146], [13200, 51, 52], [13900, 42, 120], [14600, 228, 132], [15300, 53, 65], [16000, 170, 184], [16700, 153, 170], [17400, 49, 114], [18100, 341, 96], [18800, 187, 90], [19500, 320, 108], [20200, 358, 156], [20900, 215, 68], [21600, 242, 135], [22300, 354, 42], [23000, 336, 91], [23700, 111, 188], [24400, 101, 142], [25100, 131, 172], [25800, 108, 198], [26500, 208, 42], [27200, 93, 123], [27900, 74, 166], [28600, 65, 133], [29300, 298, 122], [30000, 75, 164], [30700, 346, 178], [31400, 44, 165], [32100, 261, 179]],
  
  [[4100, 310, 189], [4700, 119, 52], [5300, 324, 180], [5900, 250, 149], [6500, 174, 178], [7100, 194, 58], [7700, 159, 125], [8300, 159, 94], [8900, 111, 189], [9500, 255, 141], [10100, 247, 115], [10700, 91, 59], [11300, 310, 162], [11900, 240, 183], [12500, 205, 168], [13100, 65, 132], [13700, 249, 138], [14300, 197, 85], [14900, 106, 80], [15500, 188, 156], [16100, 172, 43], [16700, 229, 78], [17300, 88, 176], [17900, 104, 154], [18500, 338, 197], [19100, 218, 127], [19700, 90, 128], [20300, 118, 72], [20900, 315, 106], [21500, 40, 106], [22100, 206, 123], [22700, 193, 185], [23300, 200, 162], [23900, 301, 188], [24500, 84, 96], [25100, 250, 61], [25700, 298, 197], [26300, 324, 153], [26900, 94, 139], [27500, 96, 116], [28100, 110, 55], [28700, 145, 125], [29300, 120, 108], [29900, 166, 82], [30500, 56, 182], [31100, 226, 101], [31700, 58, 48], [32300, 145, 134]],
  
    [[4100, 316, 65], [4600, 334, 102], [5100, 109, 68], [5600, 210, 128], [6100, 86, 98], [6600, 132, 157], [7100, 41, 147], [7600, 322, 194], [8100, 172, 193], [8600, 95, 187], [9100, 318, 144], [9600, 321, 104], [10100, 280, 88], [10600, 160, 51], [11100, 261, 168], [11600, 124, 85], [12100, 275, 147], [12600, 121, 114], [13100, 68, 144], [13600, 156, 87], [14100, 150, 51], [14600, 139, 137], [15100, 120, 79], [15600, 225, 137], [16100, 260, 71], [16600, 327, 190], [17100, 101, 167], [17600, 73, 43], [18100, 165, 174], [18600, 224, 169], [19100, 194, 179], [19600, 46, 134], [20100, 120, 137], [20600, 227, 50], [21100, 188, 128], [21600, 185, 153], [22100, 303, 148], [22600, 339, 79], [23100, 345, 140], [23600, 74, 92], [24100, 192, 181], [24600, 326, 130], [25100, 349, 161], [25600, 169, 139], [26100, 214, 61], [26600, 145, 183], [27100, 283, 130], [27600, 289, 90], [28100, 123, 139], [28600, 82, 63], [29100, 75, 49], [29600, 131, 65], [30100, 327, 178], [30600, 280, 69], [31100, 145, 41], [31600, 89, 180], [32100, 61, 175], [32600, 43, 48]],
  
  [[4100, 210, 86], [4500, 183, 193], [4900, 358, 176], [5300, 247, 173], [5700, 303, 97], [6100, 53, 199], [6500, 112, 139], [6900, 271, 102], [7300, 270, 186], [7700, 99, 119], [8100, 332, 81], [8500, 248, 145], [8900, 175, 99], [9300, 78, 70], [9700, 143, 88], [10100, 328, 105], [10500, 205, 99], [10900, 57, 146], [11300, 203, 70], [11700, 173, 50], [12100, 232, 190], [12500, 93, 166], [12900, 285, 64], [13300, 148, 46], [13700, 279, 84], [14100, 202, 140], [14500, 58, 77], [14900, 274, 154], [15300, 244, 157], [15700, 115, 147], [16100, 231, 107], [16500, 351, 133], [16900, 257, 62], [17300, 209, 79], [17700, 209, 118], [18100, 254, 175], [18500, 267, 145], [18900, 172, 93], [19300, 226, 98], [19700, 357, 91], [20100, 348, 155], [20500, 208, 48], [20900, 93, 56], [21300, 125, 112], [21700, 164, 155], [22100, 359, 124], [22500, 340, 146], [22900, 151, 71], [23300, 231, 113], [23700, 145, 169], [24100, 328, 95], [24500, 281, 60], [24900, 41, 122], [25300, 167, 51], [25700, 155, 85], [26100, 119, 42], [26500, 107, 139], [26900, 294, 174], [27300, 204, 172], [27700, 58, 86], [28100, 145, 161], [28500, 200, 90], [28900, 185, 119], [29300, 166, 69], [29700, 103, 99], [30100, 247, 162], [30500, 280, 124], [30900, 268, 136], [31300, 134, 178], [31700, 293, 51], [32100, 40, 61], [32500, 171, 198]],
  
  [[4100, 290, 180], [4450, 306, 142], [4800, 322, 98], [5150, 83, 195], [5500, 75, 120], [5850, 205, 140], [6200, 120, 60], [6550, 166, 57], [6900, 98, 40], [7250, 346, 69], [7600, 71, 127], [7950, 272, 120], [8300, 216, 193], [8650, 67, 195], [9000, 236, 163], [9350, 325, 81], [9700, 77, 119], [10050, 253, 74], [10400, 290, 41], [10750, 288, 185], [11100, 165, 66], [11450, 353, 87], [11800, 346, 163], [12150, 141, 92], [12500, 148, 116], [12850, 117, 118], [13200, 133, 63], [13550, 125, 157], [13900, 45, 77], [14250, 110, 156], [14600, 197, 143], [14950, 267, 184], [15300, 315, 170], [15650, 308, 68], [16000, 340, 113], [16350, 102, 145], [16700, 199, 83], [17050, 57, 55], [17400, 180, 180], [17750, 207, 147], [18100, 359, 60], [18450, 156, 126], [18800, 254, 161], [19150, 213, 75], [19500, 174, 89], [19850, 40, 46], [20200, 161, 56], [20550, 236, 113], [20900, 103, 45], [21250, 226, 52], [21600, 229, 171], [21950, 132, 54], [22300, 262, 123], [22650, 232, 183], [23000, 297, 127], [23350, 172, 161], [23700, 40, 177], [24050, 172, 130], [24400, 259, 103], [24750, 194, 102], [25100, 211, 60], [25450, 201, 168], [25800, 355, 60], [26150, 229, 67], [26500, 250, 127], [26850, 342, 150], [27200, 305, 155], [27550, 351, 54], [27900, 211, 60], [28250, 355, 44], [28600, 173, 158], [28950, 144, 106], [29300, 235, 70], [29650, 232, 83], [30000, 190, 135], [30350, 241, 98], [30700, 217, 162], [31050, 343, 167], [31400, 318, 69], [31750, 142, 102], [32100, 136, 139], [32450, 101, 54], [32800, 353, 45]],
  
  [[4100, 161, 83], [4400, 46, 153], [4700, 272, 78], [5000, 132, 106], [5300, 43, 98], [5600, 245, 100], [5900, 122, 114], [6200, 317, 132], [6500, 137, 162], [6800, 355, 195], [7100, 265, 104], [7400, 228, 57], [7700, 286, 150], [8000, 327, 132], [8300, 225, 176], [8600, 284, 179], [8900, 314, 63], [9200, 122, 83], [9500, 187, 60], [9800, 307, 128], [10100, 263, 126], [10400, 268, 143], [10700, 345, 173], [11000, 183, 162], [11300, 189, 53], [11600, 98, 173], [11900, 153, 62], [12200, 266, 134], [12500, 314, 68], [12800, 275, 154], [13100, 156, 172], [13400, 151, 133], [13700, 125, 166], [14000, 205, 107], [14300, 186, 57], [14600, 75, 180], [14900, 270, 80], [15200, 103, 45], [15500, 82, 196], [15800, 331, 47], [16100, 324, 64], [16400, 213, 135], [16700, 323, 67], [17000, 59, 83], [17300, 137, 109], [17600, 90, 193], [17900, 325, 124], [18200, 263, 163], [18500, 142, 185], [18800, 69, 105], [19100, 149, 138], [19400, 172, 101], [19700, 151, 154], [20000, 221, 116], [20300, 300, 93], [20600, 298, 98], [20900, 105, 197], [21200, 146, 43], [21500, 94, 64], [21800, 66, 136], [22100, 95, 114], [22400, 259, 93], [22700, 117, 147], [23000, 349, 164], [23300, 288, 101], [23600, 40, 181], [23900, 253, 103], [24200, 320, 86], [24500, 52, 83], [24800, 221, 101], [25100, 89, 45], [25400, 234, 94], [25700, 160, 196], [26000, 225, 136], [26300, 352, 115], [26600, 224, 164], [26900, 336, 82], [27200, 215, 134], [27500, 242, 64], [27800, 71, 82], [28100, 176, 119], [28400, 351, 134], [28700, 340, 182], [29000, 230, 182], [29300, 84, 122], [29600, 109, 187], [29900, 100, 44], [30200, 125, 42], [30500, 201, 85], [30800, 342, 196], [31100, 224, 78], [31400, 176, 83], [31700, 276, 125], [32000, 55, 52], [32300, 247, 80], [32600, 86, 190], [32900, 286, 86]],
  
  [[4100, 278, 82], [4350, 51, 199], [4600, 157, 170], [4850, 210, 47], [5100, 101, 62], [5350, 62, 181], [5600, 270, 115], [5850, 71, 50], [6100, 294, 128], [6350, 186, 95], [6600, 104, 66], [6850, 220, 131], [7100, 230, 114], [7350, 313, 183], [7600, 350, 127], [7850, 188, 53], [8100, 230, 190], [8350, 291, 160], [8600, 102, 69], [8850, 265, 190], [9100, 106, 144], [9350, 332, 194], [9600, 109, 78], [9850, 291, 109], [10100, 302, 131], [10350, 358, 99], [10600, 119, 193], [10850, 110, 140], [11100, 286, 81], [11350, 259, 95], [11600, 281, 184], [11850, 42, 89], [12100, 165, 113], [12350, 327, 196], [12600, 103, 40], [12850, 187, 105], [13100, 44, 94], [13350, 105, 67], [13600, 228, 47], [13850, 355, 191], [14100, 308, 182], [14350, 153, 147], [14600, 182, 94], [14850, 357, 172], [15100, 310, 70], [15350, 133, 112], [15600, 236, 58], [15850, 123, 88], [16100, 192, 51], [16350, 226, 126], [16600, 253, 77], [16850, 297, 199], [17100, 358, 166], [17350, 328, 171], [17600, 119, 128], [17850, 253, 128], [18100, 48, 149], [18350, 324, 139], [18600, 280, 74], [18850, 53, 128], [19100, 116, 40], [19350, 350, 87], [19600, 322, 177], [19850, 196, 65], [20100, 86, 144], [20350, 176, 167], [20600, 261, 143], [20850, 148, 52], [21100, 158, 65], [21350, 174, 162], [21600, 104, 164], [21850, 320, 183], [22100, 46, 87], [22350, 332, 117], [22600, 260, 153], [22850, 119, 196], [23100, 216, 104], [23350, 97, 132], [23600, 281, 157], [23850, 287, 100], [24100, 254, 73], [24350, 223, 176], [24600, 299, 70], [24850, 192, 109], [25100, 88, 160], [25350, 200, 132], [25600, 247, 155], [25850, 254, 75], [26100, 142, 128], [26350, 140, 113], [26600, 218, 47], [26850, 43, 172], [27100, 275, 157], [27350, 233, 43], [27600, 127, 96], [27850, 169, 44], [28100, 310, 107], [28350, 85, 56], [28600, 304, 126], [28850, 186, 151], [29100, 340, 110], [29350, 52, 75], [29600, 358, 137], [29850, 67, 91], [30100, 134, 187], [30350, 175, 158], [30600, 250, 101], [30850, 206, 86], [31100, 91, 186], [31350, 252, 112], [31600, 319, 157], [31850, 61, 197], [32100, 348, 61], [32350, 42, 41], [32600, 319, 167], [32850, 57, 117]]

];

var red = '#DE4448'
var green = '#51B45B'
var yellow = '#DECE67'
var blue = '#5E84BE'

var powerDiv;
var game_board;
var gameStartTime;
var currentLevel;

var attackSequence = [];
var bench = [];
var powerLevel = 100;
var currentTouches = [];
var gameActive = false;
var blockedCount = 0;
var totalCount = 0;

var debugDiv;

$(document).ready(function() {
  TouchAttack.setup();
});


var TouchAttack = {
  setup: function(attribute){
    if (navigator.appVersion.indexOf('iPhone OS ') < 0) {
      this.warn('Oops come back to this site on your iPhone or iPod Touch.');
      return;
    }
    
    document.addEventListener("touchmove", TouchAttack.disableTouch, false);
    
    if (!window.navigator.standalone ) { 
      this.warn('Click the + and select "Add to Home Screen" to install TouchAttack');
      return;
    }
    
    window.onorientationchange = TouchAttack.onorientationchange;
        
    this.onorientationchange();
    
    for (var i=benchSize;i>0;i--) {
      var square = $.engineer.make('attack_square', { 
        onTouchStartFuntion: TouchAttack[mode],
        onTouchEndFuntion: TouchAttack['un'+mode]
      });
      $('body').append(square);
      bench.push(square);
    }
    
    game_board = document.getElementById('game_board'); 
    document.body.ontouchstart = TouchAttack.disableTouch;

    powerDiv = $('#powerLevel');
    debugDiv = $('#debug');
    
    powerDiv.css('width',powerLevel + '%');
    
    for (var i=levels.length;i>0;i--) {
        var div = document.getElementById('level'+i+'start');
        if (i == 1 || localStorage['level'+i]) {
          $(div).removeClass('disabled');
          div.level = i;
          div.ontouchend = function() {
            // location.reload(true);
            TouchAttack.start(this);
          };
          div.ontouchstart = function() {
            // location.reload(true);
            $(this).css('background',yellow);
          };
        }
    }

    document.getElementById('reload').ontouchend = function() {
      location.reload(true);
    }
  
  },
  warn: function(warning) {
    $('#warning')
      .fadeIn()
      .find('#warningText')
        .text(warning);
  },
  unwarn: function() {
    $('#warning').fadeOut();
    $('#game').fadeIn();
  },
  onorientationchange: function() {
    window.scrollTo(0, 1)
    var orientation = window.orientation;

    if (0 == (90 % orientation)) {
      TouchAttack.unwarn();
    } else {
      TouchAttack.warn('This game is meant to be played in landscape. Please rotate your device.');
    }
  },
  start: function(levelDiv){
    currentLevel = levelDiv.level;

    $('#Level').text('Level ' + currentLevel);
    
    attackSequence = levels[currentLevel-1];
      
    totalCount = attackSequence.length;
    
    TouchAttack.moveMenuTo(-320); // Level
    setTimeout(TouchAttack.moveMenuTo, 1000, -640); // 3
    setTimeout(TouchAttack.moveMenuTo, 2000, -960); // 2
    setTimeout(TouchAttack.moveMenuTo, 3000, -1280); // 2
    setTimeout(TouchAttack.moveMenuTo, 4000, -1920); // GO
    
    setTimeout(TouchAttack.startTimer, 4000);
    
    this[mode+'Start'](); // let's get this party started
  },
  startTimer: function(){
    timerDiv = $('#timerLevel');
    timerDiv.css({'width':'0%','background-color':red });
    setTimeout(TouchAttack.gameOver, gameLength, true);
    gameStartTime = new Date;
  },
  attackStart: function() {
    attackSequence = [];
    
    game_board.ontouchstart = TouchAttack.attack;
    game_board.ontouchmove = TouchAttack.disableTouch;
    
    setTimeout(TouchAttack.refreshPower, refreshRate);
    
    gameActive = true;
  },
  attack: function(e) {
    e.preventDefault();
    $.each(e.touches, function(i,t) {
      var x = t.pageX - (boxSize/2);
      var y = t.pageY - (boxSize/2);
      bench.push(bench.shift().send('attack', x, y));
      
      attackSequence.push([(new Date) - gameStartTime, x, y]);
    });
  },
  unattack: function(e) {
    e.preventDefault();
  },
  defendStart: function() {
    game_board.ontouchstart = TouchAttack.disableTouch;
    game_board.ontouchmove = TouchAttack.disableTouch;
    
    $.each(attackSequence, function(i,a) {
      setTimeout(TouchAttack.shoot, a.shift(), a.shift(), a.shift());
    });
    
    gameActive = true;
  },
  defend: function(e) {
    e.preventDefault();
    $(this).css({
      'background-color':yellow
    });
  },
  undefend: function(e) {
    $(this).css('display','none').data('touched',true);
  },
  shoot: function(x, y) {
    if (gameActive) {
      var square = bench.shift().send('shoot', x, y);
      bench.push(square);
      setTimeout(TouchAttack.blocked, gameSpeed, square);
    }
  },
  blocked: function(elem) {
    if (!elem.data('touched')) {
      elem.css('background', red);
      powerDiv.css('background', red);
      powerLevel = powerLevel - shotCost;
    } else {
      blockedCount++;
      powerDiv.css('background', green);
      powerLevel = powerLevel + blockValue;
      if (powerLevel > 100) { powerLevel = 100 };
    }
    powerDiv.css('width',powerLevel + '%');
    
    if (powerLevel < 1) {
      TouchAttack.gameOver(false);
    }
  },
  powerReady: function() {
    return !!(powerDiv.width() > (shotCost/480) & powerLevel > shotCost)
  },
  refreshPower: function() {
    powerLevel = powerLevel + refreshAmount;
    if (powerLevel > shotCost){
      powerDiv.css('background-color',green);
    }
    if (powerLevel > 100) { powerLevel = 100 };
    powerDiv.css('width',powerLevel + '%');
    setTimeout(TouchAttack.refreshPower, refreshRate);
  },
  gameOver: function(lived) {
    if (gameActive) {
      gameActive = false;

      game_board.ontouchstart = function() {};
      
      if (lived) {
        var resultText = "You made it! Your score was:";
        var resultColor = 'white';
        currentLevel++;
        localStorage['level'+currentLevel] = true;
      } else {
        var resultText = "You died, but you made it out with:";
        var resultColor = red;
      }
      
      $('.resultDescription').text(resultText).css('color',resultColor);
      $('#results').css('top',0);
      $('#blocked').text(blockedCount);
      $('#total').text(totalCount);
    }
  },
  disableTouch: function(event)
  {
  	event.preventDefault();
  },
  moveMenuTo: function(top){
    $('#menu').css('top',top);
  }
}

$.engineer.define('attack_square',{
  defaults: {
    onTouchStartFuntion: function() {},
    onTouchEndFuntion: function() {}
  },
  structure: function(options) {
    return $('<div/>', {
      css: {
        'background':blue,
        'position':'absolute',
        'top':-9,
        'left':0,
        'width':'1px',
        'height':'1px'
      }
    });
  },
  behavior: function(options) {
    var self = this;
    var publicMethods = {
      attack: function(x,y) {
        self.css({
          'top':y,
          'left':x,
          '-webkit-animation-name': 'shrink',
          '-webkit-animation-duration': (gameSpeed/1000)+'s'
        });
      },
      shoot: function(x,y) {
        self.data('touched',false);
        self.css({
          'display':'block',
          'background':blue,
          'top':y,
          'left':x,
          '-webkit-animation-name': 'grow',
          '-webkit-animation-duration': (gameSpeed/1000)+'s'
        });
      }
    }
    
    self[0].ontouchstart = options.onTouchStartFuntion;
    self[0].ontouchend = options.onTouchEndFuntion;
    self[0].ontouchmove = function(e) { e.preventDefault(); }
    
    self.bind('webkitAnimationEnd', function (){ 
      bench.push(self.css({
        'top':-9,
        '-webkit-animation-name': null,
        '-webkit-animation-duration': null
      }));
    });
    
    return publicMethods;
  }
});